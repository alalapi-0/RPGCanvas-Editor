# RPGCanvas Editor

## 项目简介
RPGCanvas Editor 是一个基于原生 HTML5 Canvas 的 RPG Maker 风格 2D 地图编辑器。项目遵循“纯前端、零依赖”的设计理念，强调可维护的模块化结构，预计在多轮迭代中逐步完善地图绘制、素材管理与导入导出等功能。

## 当前目标
- **R1**：搭建最小可运行页面框架，完成布局、模块占位与初始化日志。
- **R2**：实现网格绘制与基础相机系统，支持平移、缩放及状态栏反馈。
- **R3**：建立地图数据模型、图层网格与基础数据层 API，为后续素材渲染与编辑工具打基础。
- **R4**：加载素材 manifest，完成素材包索引与素材面板的交互基础。
- **R5**：实现图集切片绘制、画笔预览与旋转快捷键，为后续放置操作铺路。
- **R6**：实现静态地图渲染、左键放置/右键删除的拖拽交互与多图层编辑切换。
- **R7**：引入 A1 动画帧规则与 32→48 缩放渲染，统一全局动画时钟并让素材面板与画布同步播放。

## R2 新增说明：网格、相机平移、缩放
- Canvas 采用脏渲染循环，仅在状态改变时重新绘制，提高性能。
- 渲染器内置 48×48 的网格绘制逻辑，可通过工具栏按钮即时开关。
- 相机支持鼠标中键拖动与空格+左键拖动进行平移；滚轮实现 0.5–2.0 范围的缩放，并保持鼠标位置为缩放锚点。
- 状态栏实时显示缩放百分比与鼠标在画布内的屏幕坐标，便于后续扩展世界坐标信息。

## R3 新增说明：地图与图层数据模型
- 引入 `MapData` 统一数据结构，包含地图尺寸、固定的 48×48 单元格与五个预设图层。
- 每个图层使用二维数组 `TileGrid`，单元格可存储 `TilePlacement` 或 `null`，方便序列化与调试。
- `Editor` 模块新增纯数据层 API，可创建地图、读写/删除单格图块并执行越界与参数校验。
- UI 状态栏新增地图信息显示；工具栏附加调试按钮，便于在验收时验证数据读写流程。

## R4 新增说明：素材清单与素材面板
- 新增 `Assets` 管理器，负责加载 `assets/manifest.json`，对 `tileSize`、`packs`、`tile.rect` 等关键字段进行校验。
- 所有素材在加载阶段建立 `tileId -> tileDef` 索引，控制台可通过 `Assets.getTileById('dgn.chest')` 查询定义。
- 素材面板提供素材包下拉、`tileId` 搜索过滤与缩略图按钮，点击后调用 `Editor.setSelectedTile()` 更新画笔。
- 缩略图采用 `Assets.makeTileThumb()` 生成的 48×48 离屏 Canvas；缺失图集或越界时以红底黑叉兜底并输出警告。
- 状态栏追加“画笔”字段实时显示当前选中的 `tileId`，为后续绘制工具奠定 UI 基础。

## R5 新增说明：图集静态绘制与画笔预览
- `Renderer.drawTileImage()` 基于 manifest 中的 `rect` 定义切片区域，并通过 `Assets.getImageFor()` 加载图集后在世界坐标绘制静态帧。
- 新增画笔预览层，选中素材后在鼠标所在格位显示半透明“幽灵”贴图，并绘制高亮框提示吸附的 48×48 网格。
- 按 `R` 键可以在 0/90/180/270° 间循环旋转预览，状态栏同步显示角度，预览与高亮框会随相机缩放/平移正确更新。

## R6 新增说明：地图渲染、放置/删除/拖拽与图层切换
- `Renderer.setMap()` 将数据层的 `MapData` 注入渲染器，`render()` 通过 `_calcVisibleRange()` 仅遍历视口内的网格，按 `ground→structure→prop→overlay→decal` 顺序绘制；缺失素材会用红色叉框兜底提示。
- `Editor.paintAt()` / `Editor.eraseAt()` 负责统一的数据写入与删除校验，自动校验图层匹配、越界与素材合法性，并在成功修改时设置 `state.mapDirty=true`。
- UI 新增工具栏 `layerSelect` 下拉框与状态栏提示，左键落笔、右键橡皮擦均支持拖拽连续操作；越界或图层不匹配时会在状态栏短暂提示并阻止写入。
- 预览框在越界或图层不匹配时会改用 `--warn` 红色描边，同时仍显示幽灵贴图辅助对位；未加载地图时只显示灰色框体，避免误认为可以落笔。

## R7 新增说明：动画时钟与 A1 32→48 渲染
- **A1 切片规则重构**：按照 RPG Maker VX A1 版式解析 `Dungeon_A1.png`，每个 256×96 区块被拆分为 4 条 64×96 帧带；`animated:3` 的素材统一以 f=0 帧带的 32×32 小片为基准，并通过 `animStrideX:64` 依次偏移到 f=1/2 帧。
- **32→48 缩放绘制**：`Assets.drawToCanvas()` 与 `Renderer.drawTileImage()` 会根据 `rect[2]/rect[3]` 自动判断源尺寸（32 或 48 像素），目标绘制始终拉伸到 48×48 地图单元，确保画布与缩略图一致。
- **全局动画时钟**：渲染器新增 `anim = { fps, frame, elapsed, running, maxFrame }`，通过 `performance.now()` 计算时间差，在固定 FPS 下循环帧索引并触发脏渲染；地图单元支持 `placement.animOffset` 叠加偏移实现错峰播放。
- **素材面板联动**：面板缩略图改为调用共享的 `Assets.drawToCanvas()`，使用与渲染器相同的 `anim.frame` 刷新；仅当当前 pack 含动画素材时持续循环，并在缩略图右上角显示 `3f` 徽标提示帧数。
- **警告与兜底**：manifest 若将 A1 动画 `rect` 指向非 f=0 帧带或未对齐 32 像素，会在控制台输出 `[Assets] animated tile rect not in f=0 strip` 警告，并在缩略图加红框提示；图像缺失或越界时统一渲染红底黑叉。
- **当前局限**：本轮仅实现动画播放，AutoTile 邻接规则暂未启用，计划在 R9 中补全自动换形逻辑。

## R8 新增说明：A1 16 掩码自动边角（简化版）
- **四向掩码**：以同一 A1 大组（64×96 像素区块）为判定条件，检查北/东/南/西四个方向的相邻格是否与当前格同组，将结果写入位掩码 `mask = (N?1:0)|(E?2:0)|(S?4:0)|(W?8:0)`。越界或非同组地形视为 0。
- **象限拼接**：每个 48×48 单元被拆分为 `NW/NE/SE/SW` 四个 16×16 象限，根据掩码查表决定填充 (`FILL`)、边 (`EDGE_*`) 或外角 (`CORNER_OUT_*`) 角色，再通过旋转复用 A1 帧内的 32×32 子片。
- **查表驱动**：`js/autotile16.js` 将 0..15 的掩码写成常量 `TABLE`，便于开发期直接覆写或调试；`resolveMask()` 会返回深拷贝的象限描述 `{ role, rot }`，渲染器依此调用 `composeTileQuad()`。
- **角色映射**：默认约定 `FILL` 对应大组中心 `(1,1)`，`EDGE_T` 使用 `(1,0)`，`CORNER_OUT_TL` 使用 `(0,0)`，其余方向通过旋转获得；如需针对单个素材包微调，可在控制台写入 `window.RPG.AutoTile16.roleMapPerPack['Dungeon_A1'] = { EDGE_T:[0,1], FILL:[1,1] }` 等映射覆盖。
- **渲染流程**：`Renderer.drawA1Auto16()` 负责计算掩码、查表并拼合四象限；`Editor.getNeighborMask()` 暴露纯数据层的掩码计算，方便后续用于导出或工具化；若图像尚未加载，则回退为缺失提示并异步请求重绘。
- **素材面板提示**：属于自动拼角的 A1 子片会在缩略图按钮右下角显示 “Auto16” 徽标，方便区分可自动换形的素材。

### 掩码查表与调试
`AutoTile16.TABLE` 中的 16 项定义了掩码到四象限角色的映射，开发时可在控制台打印 `window.RPG.AutoTile16.resolveMask(mask)` 验证结果；需要调整默认规则时可以直接修改表格（或通过热替换写回自定义版本），刷新即可看到新的边角组合。

### 角色映射覆写流程
1. 在控制台定位当前包名，例如 `Dungeon_A1`。
2. 构造自定义映射对象：
   ```js
   window.RPG.AutoTile16.roleMapPerPack['Dungeon_A1'] = {
     FILL: [1, 1],
     EDGE_T: [0, 1],
     CORNER_OUT_TL: [0, 2],
   };
   ```
3. 调整后调用 `window.RPG.Renderer.requestRender()` 即可实时刷新地图效果；需要持久化时请将最终值写回 manifest 或后续的配置文件。

### 升级路径（16→47/48 完整规则）
- **补足内凹角**：当前版本仅绘制外角、边与填充，后续可在表中补充 concave 角色并扩展素材占位符（如 `(0,1)`、`(1,2)`）。
- **提高分辨率**：目前以 32→16 的象限缩放保证快速对齐，将来可改为 32→24 或 48×48 全尺寸拼装，以获得更平滑的边缘过渡。
- **拓展图层适配**：R8 仅对 ground 层启用；若后续 manifest 引入水面覆层或熔岩动画，可在 `Editor.getNeighborMask()` 中添加图层参数与缓存策略。
- **可视化调试工具**：UI 预留 `Auto16` 徽标，可继续扩展为开发者面板，支持下拉选择 `(cx, cy)` 并实时预览差异，减少手动调 manifest 的成本。

## Dungeon_A1 专用说明

### 《Dungeon_A1 的 4×4 组槽与滑窗三帧》
下图基于 512×384 像素的 `Dungeon_A1.png` 进行示意：

```
+------------------------------- 512 px --------------------------------+
| Slot 01 | Slot 02 | Slot 03 | Slot 04 |  ▲ 每个 slot 宽 128 px，高 96 px
|---------+---------+---------+---------|  │
| Slot 05 | Slot 06 | Slot 07 | Slot 08 |  │ 行优先编号（左→右，上→下）
|---------+---------+---------+---------|  │
| Slot 09 | Slot 10 | Slot 11 | Slot 12 |  │
|---------+---------+---------+---------|  │
| Slot 13 | Slot 14 | Slot 15 | Slot 16 |  ▼
+-----------------------------------------------------------------------+

Slot 内部再细分为 4 列 × 3 行的 32×32 小格：

列索引 → 0   1   2   3
行索引 ↓ +---+---+---+---+
          | A | B | C | D |
          +---+---+---+---+
          | E | F | G | H |
          +---+---+---+---+
          | I | J | K | L |
          +---+---+---+---+

- **动画滑窗**：
  - 帧 0 取列对 (0,1)，即 [A,B]、[E,F]、[I,J]。
  - 帧 1 取列对 (1,2)，即 [B,C]、[F,G]、[J,K]。
  - 帧 2 取列对 (2,3)，即 [C,D]、[G,H]、[K,L]。
- **静态入库**：预览与 manifest 均使用最右侧的列对 (2,3)，保证 32×32 静态格共 6 枚。
```

### 《为什么一组只有 6 个入库格但仍能动画》
- 每个 slot 的右两列（列索引 2 与 3）恰好覆盖三行，共 6 个 32×32 区块。
- 切片器仅向素材库登记这 6 个“静态格”，以保持素材面板整洁。
- 渲染阶段读取 `animated:3` 与 `animWindowCols: [0,1,2]`，按滑窗规则将采样列替换为 (0,1)、(1,2)、(2,3)。
- 因此素材在 manifest 中看似静态，实际绘制时仍能播放三帧动画，且不会出现整块平移导致的抖动。

### 《名称顺序与重排》
- `assets/tiles/Dungeon_A1.txt` 按行给出 16 组的中英文名称，格式为 `English | 日本語`，默认行序即 slot 1→16。
- `assets/tiles/Dungeon_A1.map.json` 的 `order` 数组允许把 txt 中的第 *i* 行映射到任意 slot（1 基），示例：
  ```json
  { "order": [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16] }
  ```
- 在编辑器中打开 “Dungeon_A1 Debug → 名称重排” 弹窗，可拖拽名称与 4×4 slot 对应并一键导出新的 `map.json`，刷新后即时生效。

### 《验收步骤》
1. 在素材面板选择 `Dungeon_A1`，确认显示 16 张组卡，每张卡下方有 6 个静态格，共 96 个按钮。
2. 勾选 “显示 4×4 切片网格”，地图画布将叠加 128×96 的红色网格，与贴图内容完全对齐。
3. 选取任意一格涂抹在地图上，拖动调试帧滑杆到 0/1/2，可看到贴图轮换列对而无横向位移抖动。
4. 观察 “Water”“Lava” 等组卡，面板缩略图与画布绘制在滑杆为自动时均随全局时钟循环播放。
5. 修改 `Dungeon_A1.map.json` 的 `order` 并刷新页面，组卡标题与排列顺序按新映射更新。
6. 打开浏览器控制台可见 `[RPGCanvas] Dungeon_A1 slicer: 16 groups / 96 tiles ready` 日志，且无额外报错。

## 数据结构 Schema
```js
{
  name: "Map001",          // string：地图名称
  width: 50,                // number：地图宽度（格）
  height: 30,               // number：地图高度（格）
  tileSize: 48,             // number：单元格像素尺寸（固定）
  layers: {
    ground:    TileGrid,
    structure: TileGrid,
    prop:      TileGrid,
    overlay:   TileGrid,
    decal:     TileGrid
  },
  meta: {
    createdAt: "ISO8601",   // string：创建时间戳
    updatedAt: "ISO8601",   // string：更新时间戳
    version: "0.1.0"        // string：数据结构版本
  }
}
```
- **TileGrid**：`height` 行 × `width` 列的二维数组，单元值为 `TilePlacement` 或 `null`。
- **TilePlacement**：
  ```js
  {
    tileId: "dgn.floor_rock", // string：素材唯一 ID
    rotation: 0,               // number：旋转角度（0/90/180/270）
    flipX: false,              // boolean：水平翻转
    flipY: false,              // boolean：垂直翻转
    animOffset: 0,             // number：动画帧偏移（非负整数）
    walkable: undefined,       // boolean|undefined：可行走属性覆盖
    blocks: undefined          // boolean|undefined：阻挡属性覆盖
  }
  ```

## manifest schema
- `tileSize`：全局单元格像素尺寸，RPGCanvas 固定为 48，若 manifest 中出现其他值会在加载时抛错。
- `version`：manifest 文件自身版本号，便于后续兼容策略，本轮样例为 `0.3.0`。
- `packs[]`：素材包数组，每项包含 `name`（下拉菜单显示名）、`src`（图集文件名）和 `tiles[]`。
- `tiles[].id`：素材唯一标识字符串，用于画笔与索引。
- `tiles[].rect`：`[x, y, w, h]` 数组，描述首帧的像素区域；A1 动画素材使用 32×32 小片，其余规则块使用 48×48。
- `tiles[].layer`：素材所在图层，限定在 `ground / structure / prop / overlay / decal`。
- `tiles[].animated`：可选的正整数，表示帧数；A1 动画固定为 3，静态素材可省略。
- `tiles[].animStrideX`：仅当 `animated` 存在时有效，表示每帧在图集上向右偏移的像素值；A1 统一使用 64。
- `tiles[].rect` 若用于 A1 动画，必须落在对应帧带的 f=0 区域（即 strip 左侧 64 像素内），否则加载时会输出警告并在缩略图上显示红框。
- `tiles[].walkable` / `tiles[].blocks`：可选布尔值，覆盖默认通行/阻挡属性。
- `tiles[].affordances`：可选字符串数组，描述额外交互标签（如 `stairs_up`、`ladder`）。
- `tiles[].occluderTopPx`：可选非负整数，表示墙体遮挡高度，供后续遮挡渲染使用。

## 如何扩充 manifest
1. 对常规 A2/A4/A5 图集仍以 48×48 网格切片；对于 A1 动画块，请以 32×32 小片读取 f=0 帧带中的首帧坐标。
2. `animated` 与 `animStrideX` 必须成对出现，且均为正整数；A1 统一配置 `animated:3` 与 `animStrideX:64`。
3. 若 `rect` 未落在 f=0 帧带（strip 左侧 64 像素）或未按 32 对齐，加载阶段会输出警告并在缩略图绘制红框，便于迅速定位错误。
4. 建议每次新增条目后刷新页面检查面板缩略图是否正常播放；也可在控制台执行 `Assets.getTileById('a1.water.cell00')` 检查动画属性。

## 缩略图生成策略
- `Assets.makeTileThumb()` 与 `Assets.drawToCanvas()` 共享绘制逻辑，统一禁用插值并在 48×48 目标尺寸内渲染源图块。
- 动画素材会根据渲染器的 `anim.frame` 逐帧刷新；面板中仅当存在动画素材时才保持循环，静态素材仍按需重绘。
- 若图集缺失、尚未加载或 `rect` 越界，缩略图会渲染红底黑叉并输出 `[Assets]` 警告，同时在按钮上附带红色高亮边框。

## API 文档（Editor 数据层）
- `Editor.createNewMap(name, width, height) -> MapData`
  - `name` 为非空字符串，`width/height` 为 1–500 的正整数；创建时自动生成 5 个层的 `TileGrid` 并写入元数据。
- `Editor.setCurrentMap(mapData)`
  - 接受符合 Schema 的对象；校验 `tileSize`、层结构与元数据后，设置为当前地图并派发 `rpg:map-changed` 事件。
- `Editor.getCurrentMap() -> MapData | null`
  - 返回当前加载的地图引用，未加载时为 `null`。
- `Editor.inBounds(x, y) -> boolean`
  - 要求整数坐标；未加载地图或越界时抛出 `[Editor]` 前缀错误。
- `Editor.getTile(layerName, x, y) -> TilePlacement | null`
  - 校验图层名称与坐标范围，返回浅拷贝的图块数据。
- `Editor.setTile(layerName, x, y, placement)`
  - 校验 `placement` 结构（包含 `tileId`、合法旋转与布尔翻转）后写入数据，并刷新 `meta.updatedAt`。
- `Editor.removeTile(layerName, x, y)`
  - 将目标单元格写入 `null` 并刷新 `meta.updatedAt`。
- `Editor.setActiveLayer(layerName)` / `Editor.getActiveLayer()`
  - 切换或读取当前激活图层，非法图层名称会抛出 `[Editor]` 错误。

所有参数错误、越界或结构问题均会抛出带 `[Editor]` 前缀的异常，便于快速定位。

## 使用说明
### 基础操作
1. 打开 `index.html` 即可启动编辑器，无需任何构建工具或第三方依赖。
2. 鼠标滚轮控制缩放，范围限制在 0.5–2.0；缩放时以指针所在点为锚点。
3. 按住鼠标中键拖动即可平移视图；亦可按住空格再用左键拖动完成平移。
4. 工具栏提供 `Grid` 切换按钮与两个调试按钮：
   - “新建 50×30 地图”调用 `Editor.createNewMap` + `Editor.setCurrentMap`，状态栏显示 `名称(Map001) 50×30`。
   - “写入样例格 (ground,10,5)” 会写入示例 `TilePlacement` 并在控制台打印 `Editor.getTile` 的返回值。
5. 工具栏右侧提供 `layerSelect` 下拉框，可在 `ground/structure/prop/overlay/decal` 间切换当前编辑图层，状态栏与预览颜色会随之更新。
6. 状态栏字段：
   - `名称(...) 宽×高`：显示当前地图名称与尺寸，未加载地图时显示 `无地图`。
   - `缩放 | 旋转`：展示当前缩放百分比与画笔预览的旋转角度。
   - `格`：展示鼠标在画布内吸附的网格坐标；鼠标移出后恢复 `-`。
   - `画笔`：显示当前选中的素材 `tileId`，若素材包含动画帧，会附加 `动画: 3帧@6fps` 形式的提示；未选择时为 `-`。

### R5 画笔预览流程
1. 在左侧素材面板点击任意素材（例如 `dgn.floor_rock`），`Editor` 与 `Renderer` 会同步当前画笔。
2. 将鼠标移动到画布，出现吸附网格的半透明预览贴图，并绘制 48×48 高亮框辅助定位。
3. 使用滚轮缩放或中键/空格拖动相机，预览贴图与高亮框会随相机运动保持正确位置与比例。
4. 按 `R` 键循环切换 0/90/180/270° 旋转角度，状态栏 `缩放 | 旋转` 字段同步更新角度文本。

### R6 放置/删除/拖拽流程
1. 点击工具栏“新建 50×30 地图”创建示例地图，状态栏将显示新的地图名称与尺寸。
2. 在素材面板选中任一素材，例如 `dgn.floor_rock`，画笔状态与预览同步更新。
3. 通过工具栏右侧的 `layerSelect` 切换到素材声明的图层（如 `ground`），状态栏 `图层` 字段会随之变更。
4. 将鼠标移动到画布，预览自动吸附到 48×48 网格；在合法区域左键单击即可放置图块，按住左键拖动可连续铺设。
5. 右键单击可删除当前图层对应格；按住右键拖动会触发橡皮擦模式，快速清除大面积区域。
6. 当鼠标越界或图层不匹配时，预览描边会变为红色，并通过状态栏短暂提示，同时左键落笔被阻止。

### R7 动画预览同步
1. 在素材面板切换到 `Dungeon_A1`，点击带有 `3f` 徽标的 `a1.water.cell00` 或 `a1.water.cell11`，按钮会显示动态缩略图。
2. 将鼠标移动到画布，画笔幽灵贴图会随全局动画时钟播放；左键放置后，地图上的水面格子与面板缩略图保持同速循环。
3. 可在 `js/renderer.js` 中调整 `Renderer.anim.fps` 验证播放速度，面板、画布与状态栏提示会同步变化。
4. 若 manifest 故意将 A1 动画 `rect` 调整到非 f=0 帧带，控制台会输出警告并在缩略图绘制红色边框，便于立即发现配置错误。

## 技术要点
- **相机与坐标换算公式**：
  - 屏幕转世界：`worldX = camera.x + screenX / camera.zoom`，`worldY = camera.y + screenY / camera.zoom`。
  - 世界转屏幕：`screenX = (worldX - camera.x) * camera.zoom`，`screenY = (worldY - camera.y) * camera.zoom`。
- **以鼠标为锚点的缩放**：
  - 在缩放前记录锚点的世界坐标 `anchorWorld`；缩放后重置相机为 `camera.x = anchorWorld.x - anchorScreenX / zoom`（Y 同理），确保锚点仍落在原屏幕位置。
- **脏渲染策略**：
  - 渲染器维护 `needsRender` 标记，仅在相机平移、缩放、尺寸变化或网格开关变化时触发 `render()`，通过 `requestAnimationFrame` 循环判断是否需要重绘。
- **图集静态绘制与画笔预览**：
  - `Renderer.drawTileImage()` 根据 `tileDef.rect` 与帧索引切片绘制，结合 `worldToScreen()` 保证缩放后尺寸正确。
  - 画笔预览使用 `Renderer.brush` 存储吸附的格坐标，配合 `screenToWorld()` 让鼠标移动时自动吸附到 48×48 网格。
  - 预览层在渲染流程末尾绘制，先叠加半透明素材，再绘制高亮描边框，确保始终覆盖在网格线之上。
- **地图渲染与图层裁剪**：
  - `Renderer._calcVisibleRange()` 基于相机位置和缩放计算可见网格的闭开区间，并与地图尺寸裁剪，仅遍历视口附近的格子，保持大地图下的渲染性能。
  - 缺失素材会调用 `_drawMissingTile()` 绘制红色叉框，便于在 manifest 不完整时快速排查问题。
- **数据层与显示层解耦**：
  - `Editor.paintAt()/eraseAt()` 统一处理越界、图层匹配与素材合法性校验，并通过 `mapDirty` 标记数据已改动，为后续保存/撤销功能铺垫。
  - UI 调用数据层接口后仅在成功修改时触发 `Renderer.requestRender()`，避免重复写入导致的冗余刷新。
- **交互提示与状态栏联动**：
  - `layerSelect`、状态栏 `图层/画笔/提示` 字段实时反映编辑状态，越界或图层不匹配时会在状态栏短暂显示警告并配合预览红框提示。

## 目录结构
```
/ (项目根目录)
├─ index.html              # 页面入口，定义布局与脚本加载顺序
├─ css/
│  └─ styles.css           # 全局主题变量、布局与组件样式
├─ js/
│  ├─ main.js              # 应用入口，组织初始化流程与全局事件
│  ├─ renderer.js          # 渲染器，实现网格、相机与脏渲染循环
│  ├─ editor.js            # 编辑器状态与地图数据模型
│  ├─ ui.js                # UI 交互逻辑，绑定工具栏与相机控制
│  ├─ assets.js            # manifest 加载、素材索引与缩略图生成
│  └─ io.js                # 导入导出工具，提供 JSON 读写校验
├─ assets/
│  └─ manifest.json        # 示例素材清单，提供最小可运行的 A1 动画 + A2 静态示例
├─ data/
│  └─ .keep                # 占位文件，保持目录以存放后续示例数据
└─ README.md               # 项目文档（本文件）
```

## 运行方式
1. 直接双击 `index.html`，使用现代浏览器（推荐 Chrome / Edge）打开即可预览。
2. 若浏览器策略限制本地文件访问，可使用 VSCode Live Server 或任意静态服务器启动根目录。
3. 打开浏览器开发者工具，可在控制台看到启动日志与数据模型就绪提示，验证功能是否正常。

## 验收步骤（R7）
1. 打开页面后，`Dungeon_A1` 中标记 `animated:3` 的素材在面板缩略图内循环播放；静态素材保持不动。
2. 选中任一 A1 动画素材，将鼠标移动到画布，画笔预览会与面板同步播放；左键放置后，地图格子的动画持续循环。
3. 修改 `Renderer.anim.fps`（例如改为 12）后刷新，面板、画布与预览均以新的 FPS 播放，验证全局时钟统一。
4. 同一地图中同时放置 A1 动画与 48×48 静态素材，确认 32×32 源片被正确缩放到 48×48 单元且不影响静态素材显示。
5. 将 manifest 中某个 A1 动画条目的 `rect` 故意改到帧带右侧，再次加载会在控制台输出警告并在缩略图显示红色描边。
6. 控制台包含日志 `[RPGCanvas] R7 animation clock + A1 32→48 ready`，全程无错误或未处理异常。
7. 所有 JavaScript 文件继续保持逐行中文注释，浏览器控制台无语法警告。

## 验收步骤（R6）
1. 新建地图后，画布仅显示棋盘网格与坐标轴背景，不会出现残留素材。
2. 在素材面板选择 `dgn.floor_rock` 等素材并切换到匹配图层（如 `ground`），左键单击能放置一格，按住左键拖动可连续铺设。
3. 右键单击会删除当前图层对应格，按住右键拖动可以连续擦除形成橡皮擦效果。
4. 当鼠标越界或图层不匹配时，预览描边变为红色并阻止落笔，状态栏显示短暂提示且控制台输出 `console.warn` 记录。
5. 中键/空格拖动平移与滚轮缩放依旧正常，大地图（如 100×100）得益于视口裁剪仍保持流畅渲染。
6. 切换 `layerSelect` 不会影响已放置内容，渲染顺序始终遵循 ground→structure→prop→overlay→decal。
7. 控制台包含日志 `[RPGCanvas] R6 paint/erase + map render ready`（自 R7 起新增动画日志，可同时出现），全程无错误或未处理异常。
8. 所有 JavaScript 文件继续保持逐行中文注释，浏览器控制台无语法警告。

## 验收步骤（R5）
1. 在素材面板选中任意素材，将鼠标移动到画布内，应出现吸附网格的半透明预览贴图与 48×48 高亮框。
2. 使用中键拖动或滚轮缩放相机，预览贴图与高亮框随画面移动、缩放仍与网格对齐。
3. 按 `R` 键循环 0/90/180/270°，预览旋转同步变化，状态栏 `缩放 | 旋转` 字段显示当前角度。
4. 未选择素材或鼠标离开画布时，预览贴图与高亮框同时隐藏。
5. 控制台可看到日志 `[RPGCanvas] R5 atlas static draw + brush preview ready`（自 R6 起替换为 `[RPGCanvas] R6 paint/erase + map render ready`），无报错输出。
6. 所有 JavaScript 文件保持逐行中文注释，无语法警告。

## 验收步骤（R4）
1. 打开 `index.html`，侧边栏会在 manifest 加载完成后显示素材包下拉、搜索框与素材缩略图网格。
2. 默认选中首个素材包（示例为 `Dungeon_A1`），可看到 `a1.water.cell00`、`a1.water.cell11` 等缩略图，其中动画素材带有 `3f` 徽标。
3. 点击任意缩略图，状态栏的“画笔”字段更新为对应 `tileId`，按钮进入 `.selected` 高亮并在动画素材上显示动态效果。
4. 切换素材包或输入关键字（如 `ladder`）可实时过滤缩略图列表。
5. 控制台保持无报错；若 PNG 缺失或 `rect` 越界，缩略图显示红底黑叉并输出 `[Assets]` 警告。
6. 在控制台执行 `Assets.getTileById('dgn.chest')`，返回的对象包含 `layer`、`rect` 等字段。
7. 控制台出现日志 `[RPGCanvas] R4 manifest+asset panel ready`，说明素材面板初始化完成。

## 验收步骤（R3）
1. 打开 `index.html`，点击工具栏“新建 50×30 地图”，状态栏应显示 `名称(Map001) 50×30`。
2. 点击“写入样例格 (ground,10,5)”按钮，浏览器控制台应打印 `sample getTile = ...`，对象内容包含 `tileId: 'dgn.floor_rock'`。
3. 在控制台执行：
   - `Editor.inBounds(10,5)` 返回 `true`，`Editor.inBounds(-1,0)` 返回 `false`。
   - `Editor.getTile('ground',10,5)` 返回 `TilePlacement`；执行 `Editor.removeTile('ground',10,5)` 后再次读取应为 `null`。
   - `IO.serialize(Editor.getCurrentMap())` 返回格式化 JSON 字符串；再通过 `IO.deserialize(字符串)` 应恢复等价对象。
4. 尝试传入非法参数（错误图层名、越界坐标、缺少 `tileId` 等）会抛出带 `[Editor]` 或 `[IO]` 前缀的错误。
5. 控制台包含日志 `[RPGCanvas] R3 data model ready`，且无未处理异常或警告。
6. 所有 JavaScript 文件保持逐行中文注释，无语法警告。

## 后续衔接
- **R8**：完善世界坐标与吸附提示，提供更精确的拾取与状态显示。
- **R9**：实现 A1 自动拼贴邻接规则，让动画水面按照地形自动切换边缘。

## 后续路线图（第 3 ~ 15 轮概述）
- **第 3 轮**：实现基础地图数据结构与新建地图对话流程。
- **第 4 轮**：完成素材加载与缩略图渲染，占位资产替换为真实 PNG。
- **第 5 轮**：加入网格绘制优化与相机交互增强（惯性、限制边界等）。
- **第 6 轮**：实现图层可见性控制与图层排序面板。
- **第 7 轮**：添加基础绘制工具（画笔/橡皮擦）与撤销重做系统。
- **第 8 轮**：完善状态栏信息，显示地图尺寸、图层与光标世界坐标。
- **第 9 轮**：实现素材包管理界面（过滤、搜索、标记收藏）。
- **第 10 轮**：加入多地图项目支持与快速切换功能。
- **第 11 轮**：整合键盘快捷键与自定义配置存储。
- **第 12 轮**：添加辅助工具（对齐线、区域选择、填充）。
- **第 13 轮**：优化性能（离屏渲染、虚拟滚动）并增强地图体验。
- **第 14 轮**：提供导出预览与截图分享功能。
- **第 15 轮**：完成文档、单元测试与发布准备。

## 变更日志
- **R7**：动画时钟 + A1 32→48 渲染完成。
- **R6**：放置/删除/拖拽与地图渲染完成。
- **R5**：图集静态绘制与画笔预览完成。
- **R4**：完成素材清单加载、素材面板筛选与画笔状态联动。
- **R3**：完成地图数据模型、图层 API、状态栏地图信息与基础导入导出校验。
- **R2**：完成 Canvas 网格、相机平移/缩放与状态栏联动。
- **R1**：构建基础布局框架与模块化脚手架。
